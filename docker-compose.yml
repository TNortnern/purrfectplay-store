version: '3.8'

services:
  # Combined app service for production-like local testing
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "6000:6000"
    environment:
      - NODE_ENV=production
      - PORT=6000
      - VENDURE_PORT=3000
      - DATABASE_URL=postgres://postgres:postgres@db:5432/catiohaven
      - SUPERADMIN_USERNAME=superadmin
      - SUPERADMIN_PASSWORD=superadmin123
      - COOKIE_SECRET=change-me-in-production
    depends_on:
      - db
    restart: unless-stopped

  # PostgreSQL for production
  db:
    image: postgres:16-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=catiohaven
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  # Development services (use with --profile dev)
  vendure-dev:
    profiles: ["dev"]
    build:
      context: ./vendure
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - APP_ENV=dev
      - SUPERADMIN_USERNAME=superadmin
      - SUPERADMIN_PASSWORD=superadmin123
      - COOKIE_SECRET=dev-secret
    volumes:
      - ./vendure:/app
      - /app/node_modules
    command: npm run dev:server

  storefront-dev:
    profiles: ["dev"]
    working_dir: /app
    image: node:20-alpine
    ports:
      - "6000:6000"
    environment:
      - NODE_ENV=development
      - VENDURE_API_URL=http://vendure-dev:3000
    volumes:
      - ./storefront:/app
      - /app/node_modules
    command: sh -c "corepack enable && pnpm install && pnpm dev"
    depends_on:
      - vendure-dev

  # Plausible Analytics (self-hosted)
  plausible:
    image: ghcr.io/plausible/community-edition:v3.1.0
    command: sh -c "sleep 10 && /entrypoint.sh db createdb && /entrypoint.sh db migrate && /entrypoint.sh run"
    ports:
      - "8001:8000"
    environment:
      - BASE_URL=${PLAUSIBLE_BASE_URL:-http://localhost:8001}
      - SECRET_KEY_BASE=${PLAUSIBLE_SECRET_KEY:-UR/InSYTCVDBx0EJviiBotHha3C9W6mImgGRDNnPqSTbJslFk8IFIDlXa8BMLTlj8FUhBNt5rywr5awohS/Hdw==}
      - DATABASE_URL=postgres://postgres:postgres@db:5432/plausible
      - CLICKHOUSE_DATABASE_URL=http://plausible_events_db:8123/plausible_events_db
      - DISABLE_REGISTRATION=false
      - LOG_LEVEL=warn
    depends_on:
      - db
      - plausible_events_db
    restart: unless-stopped

  plausible_events_db:
    image: clickhouse/clickhouse-server:25.3.2.39-alpine
    volumes:
      - plausible_events_data:/var/lib/clickhouse
      - ./plausible/clickhouse-config.xml:/etc/clickhouse-server/config.d/logging.xml:ro
      - ./plausible/clickhouse-user-config.xml:/etc/clickhouse-server/users.d/logging.xml:ro
      - ./plausible/clickhouse-users.xml:/etc/clickhouse-server/users.d/users.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    restart: unless-stopped

volumes:
  postgres_data:
  plausible_events_data:
